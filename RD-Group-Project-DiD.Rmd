---
title: "RD-Group-Project-DiD"
author: "Sophie Hensgen"
date: "11/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readr)
library(tidyverse)
library(stargazer)
library(plotly)
library(kableExtra)
library(naniar)
```

## Load Data Set


```{r load data set}
df <- read.table("public.dat")
df

```

## Code


```{r arrange data, echo=FALSE}

# arrange data to better observe

arrange(df, V1)

```

```{r Rename Varibales, echo=FALSE}

## changing into tibble
df <- as_tibble(df)

## Rename Columns for a better workflow
# x stands for independent variable/covariates
# y stands for dependent variable
# d stands for treatement variable
df <- df %>% 
  rename(
    x_id = V1,
    x_store.name = V2, #chain 1=bk; 2=kfc; 3=roys; 4=wendys
    x_co.owned = V3,
    d_state = V4, #
    x_south.j = V5,
    x_central.j = V6,
    x_north.j = V7,
    x_northeast.pa = V8,
    x_easton.pa = V9,
    x_shore.j = V10, #
    x_callbacks.first = V11,
    y_full.emp = V12,
    y_part.emp = V13,
    y_managers = V14,
    x_st.wage.before = V15,
    x_months.raise = V16, 
    x_amount.raise = V17,
    x_cash.bounty = V18,
    y_employees.affected.n.minimum = V19,
    x_reduced = V20,
    x_open.hour = V21,
    x_open.per.day = V22,
    x_medium.soda = V23,
    x_small.fries = V24,
    x_entree = V25,
    x_cash.reg = V26,
    x_reg.11 = V27, 
    x_type.sec.interview = V28, # second wave
    x_status.sec.interview = V29,
    x_date.sec = V30,
    x_callbacks.sec = V31,
    y_full.emp.sec = V32,
    y_part.emp.sec = V33,
    y_managers.sec = V34,
    x_st.wage.after = V35,
    x_months.raise.sec = V36,
    x_amount.raise.sec = V37,
    x_special.program.sec = V38,
    x_reduced.price = V39,
    x_open.hour.sec = V40,
    x_open.per.day.sec = V41,
    x_medium.soda.sec = V42,
    x_small.fries.sec = V43,
    x_entree.sec = V44,
    x_cash.reg.sec = V45,
    x_reg.11.sec = V46
    )

```

```{r Creating Variables, echo=FALSE}

# Creating a new variable which says 1 if the restaurant was interviewed in the first wave
df$x_interviewed.w1 <- (df$x_interviewed.w1 = 1)

# creating new variables for each store (x_store.name) and state (d_state) into dummies. 

# x_bk dummy variable for burger king (1) or not (0)
df$x_bk <- gsub(2, 0, df$x_store.name) 
df$x_bk <- gsub(3, 0, df$x_bk) 
df$x_bk <- gsub(4, 0, df$x_bk) 

# x_kfc dummy variable for KFC (1) or not (0)
df$x_kfc <- gsub(1, 0, df$x_store.name) 
df$x_kfc <- gsub(3, 0, df$x_kfc) 
df$x_kfc <- gsub(4, 0, df$x_kfc) 
df$x_kfc <- gsub(2, 1, df$x_kfc) 

# x_roys dummy variable for Roys (1) or not (0)
df$x_roys <- gsub(1, 0, df$x_store.name) 
df$x_roys <- gsub(2, 0, df$x_roys) 
df$x_roys <- gsub(4, 0, df$x_roys) 
df$x_roys <- gsub(3, 1, df$x_roys) 

# x_wendys dummy variable for Wendys (1) or not (0)
df$x_wendys <- gsub(1, 0, df$x_store.name) 
df$x_wendys <- gsub(3, 0, df$x_wendys) 
df$x_wendys <- gsub(2, 0, df$x_wendys) 
df$x_wendys <- gsub(4, 1, df$x_wendys)

# d_nj dummy variable for restaurants in NJ (1) or not (0)
df$d_nj <- df$d_state

# d_nj dummy variable for restaurants in PA (1) or not (0)
df$d_pa <- gsub(0, 2, df$d_state)
df$d_pa <- gsub(1, 0, df$d_pa)
df$d_pa <- gsub(2, 1, df$d_pa)


```

```{r changing class , echo=FALSE}

# Some variables are a character vector, which cannot be used in a summary. Therefore they have to be changed. 

df[,12:14] <- lapply(df[,12:14], as.factor) #first convert into factor, and then into numeric. if tried to convert directly from character into numeric an error will appear.
df[,12:14] <- lapply(df[,12:14], as.numeric)

df[,15] <- lapply(df[,15], as.numeric)

df[,16:17] <- lapply(df[,16:17], as.factor) 
df[,16:17] <- lapply(df[,16:17], as.numeric)

df[,19] <- lapply(df[,19], as.factor)
df[,19] <- lapply(df[,19], as.numeric)

df[,23:27] <- lapply(df[,23:27], as.factor)
df[,23:27] <- lapply(df[,23:27], as.numeric)

df[,31:34] <- lapply(df[,31:34], as.factor)
df[,31:34] <- lapply(df[,31:34], as.numeric)

df[,35] <- lapply(df[,35], as.numeric)

df[,36:46] <- lapply(df[,36:46], as.factor)
df[,36:46] <- lapply(df[,36:46], as.numeric)

#convert into integer as it is a dummy variable with only 0 and 1, here convert directly to integer as the numbers would change if you first convert into factor
df[,48:51] <- lapply(df[,48:51], as.integer)

df[,53] <- lapply(df[,53], as.integer)

# Creating a new variable for FTE --> full employment including managers and 0.5x part time employment

df$y_fte.before <- df$y_full.emp + df$y_managers + df$y_part.emp*0.5
df$y_fte.after <- df$y_part.emp.sec*0.5 + df$y_full.emp.sec + df$y_managers.sec 

str(df)


```

```{r, echo=FALSE}
#Summary Statistic of a subset of the data frame df

#subsetting the data frame
df.select <- df %>%
  select(x_co.owned, x_south.j, x_central.j, x_north.j, x_northeast.pa, x_easton.pa, x_st.wage.before, x_st.wage.after, x_open.per.day, x_open.per.day.sec, y_fte.before, y_fte.after, d_state, x_store.name)

#summary of the subset
stargazer(data.frame(df.select), type = "text", summary = TRUE)

```
```{r replace . with na, echo=FALSE}

  df <- df %>% replace_with_na(replace = list(y_fte.before = "." , x_st.wage.before = "." ,x_st.wage.after = ".", y_fte.after = ".")) 

```


```{r Table 1 - Sample Size and response rate, echo=FALSE}

# first wave
# d_state

# count number interviewed
count.all.w1 <- df %>% 
  count(d_state)

count.all.w1

# response rate nj
count.all.per <- df %>%
  tally(x_interviewed.w1)%>%
  mutate(percent = n/473)

# response rate nj
count.nj.per <- df %>%
  count(d_state) %>%
  filter(d_state == 1) %>%
  mutate(percent = n/364)

# response rate pa
count.pa.per <- df %>%
  count(d_state) %>%
  filter(d_state == 0) %>%
  mutate(percent = n/109)

# second wave
# x_status.sec.interview, d_state

count.all.w2 <- df %>% 
  count(x_status.sec.interview)

count.nj <- df %>% 
  filter(d_state == 1) %>% # NJ
  count(x_status.sec.interview)

count.pa <- df %>% 
  filter(d_state == 0) %>% # PA
  count(x_status.sec.interview)

count.all.w2
count.nj
count.pa

```

```{r Table 2 - Means of Key Variables, echo=FALSE}

# Khizer 


```

```{r Figure 1 - Distribution of starting wage rates, echo=FALSE}

# Sophie 

### Replication of Figure 1

## creating specific objects for starter wage before respectively for nj and pa

x_st.wage.before.nj <- df$x_st.wage.before[df$d_nj == 1]
x_st.wage.before.pa <- df$x_st.wage.before[df$d_pa == 1]

# Plot for before treatment

# Set histogram bins
xbins <- list(start=4.20, end=5.60, size = 0.1)

# 
p.before <- plot_ly(alpha = 0.5) %>%
  add_histogram(x = x_st.wage.before.nj, 
                  xbins = xbins,
                  histnorm = "percent", 
                  name = "Wage Before (New Jersey)") %>%
  add_histogram(x = x_st.wage.before.pa, 
                  xbins = xbins,
                  histnorm = "percent",
                  name = "Wage Before (Pennsylvania)") %>%
  layout(barmode = "group", title = "February 1992",
           xaxis = list(tickvals=seq(4.25, 5.55, 0.1),
                        title = "Wage in $ per hour",
                        tickangle = 90),
           yaxis = list(range = c(0, 100)),
                      margin = list(b = 100, 
                          l = 80, 
                          r = 80, 
                          t = 80, 
                          pad = 0, 
                          autoexpand = TRUE))

p.before

## creating specific objects for starter wage before respectively for nj and pa

x_st.wage.after.nj <- df$x_st.wage.after[df$d_nj == 1]
x_st.wage.after.pa <- df$x_st.wage.after[df$d_pa == 1]

# Plot for wage after treatment

p.after <- plot_ly(alpha = 0.5) %>%
  add_histogram(x = x_st.wage.after.nj, 
                  xbins = xbins,
                  histnorm = "percent", 
                  name = "Wage After (New Jersey)") %>%
  add_histogram(x = x_st.wage.after.pa, 
                  xbins = xbins,
                  histnorm = "percent",
                  name = "Wage After (Pennsylvania)") %>%
  layout(barmode = "group", title = "February 1992",
           xaxis = list(tickvals=seq(4.25, 5.55, 0.1),
                        title = "Wage in $ per hour",
                        tickangle = 90),
           yaxis = list(range = c(0, 100)),
                      margin = list(b = 100, 
                          l = 80, 
                          r = 80, 
                          t = 80, 
                          pad = 0,
                          autoexpand = TRUE))

p.after
```

```{r Table 3 - Average Employment per store before and after the raise, echo=FALSE}

# Sophie

# Table 3: Column 1-3, from left to right)

## 1st row: MEANs and SEs across subgroups
  
results.state.r1 <- df %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_fte.before) %>% # only keep variable of interest
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

# Add row with differences
  results.state.r1 <- bind_rows(results.state.r1, results.state.r1[2,]-results.state.r1[1,])
  results.state.r1$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(results.state.r1, digits=2)

# Calculate SE for difference: SE = SQR(VAR/N + VAR/N)
  diff_se.state.r1 <- sqrt(results.state.r1$var[1]/results.state.r1$n[1] + results.state.r1$var[2]/results.state.r1$n[2])
  diff_se.state.r1
  
####################################################################################################
  
## 2nd row: MEANs and SEs across subgroups
  
results.state.r2 <- df %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_fte.after) %>% # only keep variable of interest - here dummy for state and employment for second time point (after treatment)
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

   
# Add row with differences
  results.state.r2 <- bind_rows(results.state.r2, results.state.r2[2,]-results.state.r2[1,])
  results.state.r2$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(results.state.r2, digits=2)
  
####################################################################################################
  
## 3rd row: Change in MEANs and SEs between both time points

  results.state.r3 <- bind_rows(results.state.r1, results.state.r2)
  results.state.r3 <- select(results.state.r3, -8)
  results.state.r3 <- bind_rows(results.state.r3, results.state.r3[4,]-results.state.r3[1,])
  results.state.r3 <- bind_rows(results.state.r3, results.state.r3[5,]-results.state.r3[2,])
  results.state.r3 <- bind_rows(results.state.r3, results.state.r3[6,]-results.state.r3[3,])
  results.state.r3$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(results.state.r3, digits=2)  
  
####################################################################################################
  
## 4th row: Change in MEANs and SEs between both time points, balanced sample
  
# Filter observations in both waves
  df.balanced <- df %>% na.omit
    
# Filter complete cases across all columns
  df.balanced <- df %>% filter(complete.cases(.)) 
    

# Means time point 1
  
resultsb.state.r4.before <- df.balanced %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_fte.before) %>% # only keep variable of interest
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

# Add row with differences
  resultsb.state.r4.before <- bind_rows(resultsb.state.r4.before, resultsb.state.r4.before[2,]-resultsb.state.r4.before[1,])
  kable(resultsb.state.r4.before, digits=2)

# Means time point 2
  
resultsb.state.r4.after <- df.balanced %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_fte.after) %>% # only keep variable of interest 
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

   
# Add row with differences
  resultsb.state.r4.after <- bind_rows(resultsb.state.r4.after, resultsb.state.r4.after[2,]-resultsb.state.r4.after[1,])
  resultsb.state.r4.after$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(resultsb.state.r4.after, digits=2)
  
# Mean Differences 
  
resultsb.state.r4 <- bind_rows(resultsb.state.r4.before, resultsb.state.r4.after)
  resultsb.state.r4 <- select(resultsb.state.r4, -8)
  resultsb.state.r4 <- bind_rows(resultsb.state.r4, resultsb.state.r4[4,]-resultsb.state.r4[1,])
  resultsb.state.r4 <- bind_rows(resultsb.state.r4, resultsb.state.r4[5,]-resultsb.state.r4[2,])
  resultsb.state.r4 <- bind_rows(resultsb.state.r4, resultsb.state.r4[6,]-resultsb.state.r4[3,])
  resultsb.state.r4$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(resultsb.state.r4, digits=2)  
  
####################################################################################################
  
## 5th row: Change in MEANs and SEs between both time points, permanently closed set to 0
  
# Create a new variable where permanently closed stores have a FTE of 0
df$y_fte.after.closed <- df$y_fte.after
df$y_fte.after.closed[df$x_status.sec.interview == 3] <- 0
    
# Filter complete cases across all columns
df.closed <- df %>% filter(complete.cases(.)) 
    
# Before Treatment

resultsc.state.r5.before <- df.closed %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_fte.before) %>% # only keep variable of interest
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

# Add row with differences
  resultsc.state.r5.before <- bind_rows(resultsc.state.r5.before, resultsc.state.r5.before[2,]-resultsc.state.r5.before[1,])
  kable(resultsc.state.r5.before, digits=2)

# After Treatment
  
resultsc.state.r5.after <- df.closed %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_fte.after.closed) %>% # only keep variable of interest 
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

   
# Add row with differences
  resultsc.state.r5.after <- bind_rows(resultsc.state.r5.after, resultsc.state.r5.after[2,]-resultsc.state.r5.after[1,])
  kable(resultsc.state.r5.after, digits=2)
  
# Compare all the results and add the difference between them. 
  
resultsc.state.r5 <- bind_rows(resultsc.state.r5.before, resultsc.state.r5.after)
  resultsc.state.r5 <- bind_rows(resultsc.state.r5, resultsc.state.r5[4,]-resultsc.state.r5[1,])
  resultsc.state.r5 <- bind_rows(resultsc.state.r5, resultsc.state.r5[5,]-resultsc.state.r5[2,])
  resultsc.state.r5 <- bind_rows(resultsc.state.r5, resultsc.state.r5[6,]-resultsc.state.r5[3,])
  resultsc.state.r5$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(resultsc.state.r5, digits=2)    

  
```

```{r Table 3 - Average Employment per store before and after the raise, column 4-6, echo=FALSE}

# Sophie 

### Table 3: Column 4-6, Row 1 (from left to right)

## 1st row: FTE before Treatment

# Column 4

results.r1.c4 <- df %>%
  group_by(d_nj) %>%
  filter(d_nj == 1 & x_st.wage.before == 4.25) %>%
  dplyr::select(y_fte.before) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.before_na_sum) %>% 
  mutate(se = sqrt(y_fte.before_var/n))

# Column 5

results.r1.c5 <- df %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.25 & x_st.wage.before < 5 & d_nj == 1) %>%
  dplyr::select(y_fte.before) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.before_na_sum) %>% 
  mutate(se = sqrt(y_fte.before_var/n))

# Column 6

results.r1.c6 <- df %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.99 & d_nj == 1) %>%
  dplyr::select(y_fte.before) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.before_na_sum) %>% 
  mutate(se = sqrt(y_fte.before_var/n))

# Combining all the results for row 1

results.compare.r1 <- bind_rows(results.r1.c4, results.r1.c5, results.r1.c6)
kable(results.compare.r1, digits=2)

####################################################################################################

## 2nd row: After treatment

# Column 4

results.r2.c4 <- df %>%
  group_by(d_nj) %>%
  filter(d_nj == 1 & x_st.wage.before == 4.25) %>%
  dplyr::select(y_fte.after) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean = mean, var = var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.after_na_sum) %>% 
  mutate(se = sqrt(y_fte.after_var/n))

# Column 5 
#something is wrong here

results.r2.c5 <- df %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.25 & x_st.wage.before < 5 & d_nj == 1) %>%
  dplyr::select(y_fte.after) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.after_na_sum) %>% 
  mutate(se = sqrt(y_fte.after_var/n))

# Column 6
#something is wrong here

results.r2.c6 <- df %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.99 & d_nj == 1) %>%
  dplyr::select(y_fte.after) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.after_na_sum) %>% 
  mutate(se = sqrt(y_fte.after_var/n))

# Combining all the results for row 1

results.compare.r2 <- bind_rows(results.r2.c4, results.r2.c5, results.r2.c6)
kable(results.compare.r2, digits=2)

####################################################################################################

## 3rd row: After treatment

results.compare.r3 <- bind_rows(results.compare.r2, results.compare.r1)
  #results.compare.r3 <- select(results.compare.r3, -8)
  results.compare.r3 <- bind_rows(results.compare.r3, results.compare.r3[4,]-results.compare.r3[1,])
  results.compare.r3 <- bind_rows(results.compare.r3, results.compare.r3[5,]-results.compare.r3[2,])
  results.compare.r3 <- bind_rows(results.compare.r3, results.compare.r3[6,]-results.compare.r3[3,])
  results.compare.r3$group<- c()
  kable(results.compare.r3, digits=2) 
  
####################################################################################################  
  
## 4th row: Change in mean FTE in balanced sample
  
# create a balanced data set
  
  df.balanced <- df %>% filter(complete.cases(.))   
  
# Column 4 
  
  resultsb.r1.c4 <- df.balanced %>%
  group_by(d_nj) %>%
  filter(d_nj == 1 & x_st.wage.before == 4.25) %>%
  dplyr::select(y_fte.before) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.before_na_sum) %>% 
  mutate(se = sqrt(y_fte.before_var/n))

# Column 5

resultsb.r1.c5 <- df.balanced %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.25 & x_st.wage.before < 5 & d_nj == 1) %>%
  dplyr::select(y_fte.before) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.before_na_sum) %>% 
  mutate(se = sqrt(y_fte.before_var/n))

# Column 6

resultsb.r1.c6 <- df.balanced %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before >= 5 & d_nj == 1) %>%
  dplyr::select(y_fte.before) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.before_na_sum) %>% 
  mutate(se = sqrt(y_fte.before_var/n))

# Combining all the results for row 1

resultsb.compare.r1 <- bind_rows(resultsb.r1.c4, resultsb.r1.c5, resultsb.r1.c6)
kable(resultsb.compare.r1, digits=2)


## Second row: After treatment

# Column 4

resultsb.r2.c4 <- df.balanced %>%
  group_by(d_nj) %>%
  filter(d_nj == 1 & x_st.wage.before == 4.25) %>%
  dplyr::select(y_fte.after) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean = mean, var = var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.after_na_sum) %>% 
  mutate(se = sqrt(y_fte.after_var/n))

# Column 5 
#something is wrong here

resultsb.r2.c5 <- df.balanced %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.25 & x_st.wage.before < 5 & d_nj == 1) %>%
  dplyr::select(y_fte.after) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.after_na_sum) %>% 
  mutate(se = sqrt(y_fte.after_var/n))

# Column 6
#something is wrong here

resultsb.r2.c6 <- df.balanced %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.99 & d_nj == 1) %>%
  dplyr::select(y_fte.after) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.after_na_sum) %>% 
  mutate(se = sqrt(y_fte.after_var/n))

# Combining all the results for row 1

resultsb.compare.r2 <- bind_rows(resultsb.r2.c4, resultsb.r2.c5, resultsb.r2.c6)
kable(resultsb.compare.r2, digits=2)

## Third row: After treatment
# suddenly some rows have nas, i dont now why!

results.compare.r4 <- bind_rows(resultsb.compare.r2, resultsb.compare.r1)
  results.compare.r4 <- bind_rows(results.compare.r4, results.compare.r4[4,]-results.compare.r4[1,])
  results.compare.r4 <- bind_rows(results.compare.r4, results.compare.r4[5,]-results.compare.r4[2,])
  results.compare.r4 <- bind_rows(results.compare.r4, results.compare.r4[6,]-results.compare.r4[3,])
  results.compare.r4$group<- c()
  kable(results.compare.r4, digits=2) 
 
####################################################################################################
  
# 5th Rows: Permanantely closed = 0
  
# Create a new variable where permanently closed stores have a FTE of 0
df$y_fte.after.closed <- df$y_fte.after
df$y_fte.after.closed[df$x_status.sec.interview == 3] <- 0
    
# Filter complete cases across all columns
df.closed <- df %>% filter(complete.cases(.))

## Before Treatment Means
# Column 4 
  
  resultsc.r1.c4 <- df.closed %>%
  group_by(d_nj) %>%
  filter(d_nj == 1 & x_st.wage.before == 4.25) %>%
  dplyr::select(y_fte.before) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.before_na_sum) %>% 
  mutate(se = sqrt(y_fte.before_var/n))

# Column 5

resultsc.r1.c5 <- df.closed %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.25 & x_st.wage.before < 5 & d_nj == 1) %>%
  dplyr::select(y_fte.before) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.before_na_sum) %>% 
  mutate(se = sqrt(y_fte.before_var/n))

# Column 6

resultsc.r1.c6 <- df.closed %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before >= 5 & d_nj == 1) %>%
  dplyr::select(y_fte.before) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.before_na_sum) %>% 
  mutate(se = sqrt(y_fte.before_var/n))

# Combining all the results for row 1

resultsc.compare.r1 <- bind_rows(resultsc.r1.c4, resultsc.r1.c5, resultsc.r1.c6)
kable(resultsc.compare.r1, digits=2)


## After Treatment Means
# Column 4

resultsc.r2.c4 <- df.closed %>%
  group_by(d_nj) %>%
  filter(d_nj == 1 & x_st.wage.before == 4.25) %>%
  dplyr::select(y_fte.after) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean = mean, var = var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.after_na_sum) %>% 
  mutate(se = sqrt(y_fte.after_var/n))

# Column 5 

resultsc.r2.c5 <- df.closed %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.25 & x_st.wage.before < 5 & d_nj == 1) %>%
  dplyr::select(y_fte.after) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.after_na_sum) %>% 
  mutate(se = sqrt(y_fte.after_var/n))

# Column 6

resultsc.r2.c6 <- df.closed %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.99 & d_nj == 1) %>%
  dplyr::select(y_fte.after) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - y_fte.after_na_sum) %>% 
  mutate(se = sqrt(y_fte.after_var/n))

# Combining all the results for row 1

resultsc.compare.r2 <- bind_rows(resultsc.r2.c4, resultsc.r2.c5, resultsc.r2.c6)
kable(resultsc.compare.r2, digits=2)

# mean differences
# suddenly some rows have nas, i dont now why!

results.compare.r5 <- bind_rows(resultsc.compare.r2, resultsc.compare.r1)
  results.compare.r5 <- bind_rows(results.compare.r5, results.compare.r5[4,]-results.compare.r5[1,])
  results.compare.r5 <- bind_rows(results.compare.r5, results.compare.r5[5,]-results.compare.r5[2,])
  results.compare.r5 <- bind_rows(results.compare.r5, results.compare.r5[6,]-results.compare.r5[3,])
  results.compare.r5$group<- c()
  kable(results.compare.r5, digits=2) 
  
```

```{r Table 3 - Average Employment per store before and after the raise, column 7-8, echo=FALSE}

# Sophie 

# Difference between Low and High & Mid-range and high

# 1st row: Before Treatment

results.low.r1 <- bind_rows(results.compare.r1, results.compare.r1[3,3]-results.compare.r1[1,3])
results.low.r1 <- bind_rows(results.low.r1, results.compare.r1[3,3]-results.compare.r1[2,3])
kable(results.low.r1, digits=2)

####################################################################################################

# 2nd row: After Treatment

results.low.r2 <- bind_rows(results.compare.r2, results.compare.r2[3,3]-results.compare.r2[1,3])
results.low.r2 <- bind_rows(results.low.r2, results.compare.r2[3,3]-results.compare.r2[2,3])
kable(results.low.r2, digits=2)

####################################################################################################

# 3rd row: Change in Mean of FTE --> because there is an error before this does not work yet!

results.low.r3 <- bind_rows(results.compare.r3, results.compare.r3[9,3]-results.compare.r3[7,3])
results.low.r3 <- bind_rows(results.low.r3, results.compare.r3[9,3]-results.compare.r3[8,3])
kable(results.low.r3, digits=2)

####################################################################################################

# 4th row: Change in Mean of FTE in balanced sample

results.low.r4 <- bind_rows(results.compare.r4, results.compare.r4[9,3]-results.compare.r4[7,3])
results.low.r4 <- bind_rows(results.low.r4, results.compare.r4[9,3]-results.compare.r4[8,3])
kable(results.low.r4, digits=2)

####################################################################################################

# 5th row: Change in Mean of FTE, closed stores = 0

results.low.r5 <- bind_rows(results.compare.r5, results.compare.r5[9,3]-results.compare.r5[7,3])
results.low.r5 <- bind_rows(results.low.r5, results.compare.r5[9,3]-results.compare.r5[8,3])
kable(results.low.r5, digits=2)

```

```{r Table 4 - Reduced Form Models for change in employment, echo=FALSE}

# Sophie 

#First select you data set, with which you want to work

 df2 <- dplyr::select(df, 
                         y_fte.before,
                         y_fte.after,
                         d_nj,
                         x_bk,
                         x_kfc,
                         x_roys,
                         x_co.owned,
                         x_st.wage.before,
                         x_st.wage.after,
                         x_status.sec.interview,
                         x_south.j,
                         x_central.j,
                         x_northeast.pa,
                         x_easton.pa) %>%
           mutate(x_st.wage.after = case_when(x_status.sec.interview == 3 ~ NA_character_, # these stores get an NA
                                              TRUE ~ as.character(x_st.wage.after)),
                  x_st.wage.after = as.numeric(x_st.wage.after)) %>%
                  na.omit()

# Model (i)/Column 1: Base

  fit.c1 <- lm((y_fte.after-y_fte.before) ~ d_nj,
             data = df2)
  summary(fit.c1)

# Model (ii)/Column 2: Controls Chain/Ownership
  fit.c2 <- lm((y_fte.after-y_fte.before) ~ 
               d_nj + x_bk + x_kfc + x_roys + x_co.owned, 
             data = df2)
  summary(fit.c2)
  
# Model (iii)/Column 3: Initial Wage gap - no controls
  
# Create new variable were old is substracted from the new minimum
  
  df2 <- df2 %>%
    mutate(d_ini.wage.gap = 5.05 - x_st.wage.before)
  
# then linear model/regression
  
  fit.c3 <- lm((y_fte.after-y_fte.before) ~ 
               d_ini.wage.gap, 
             data = df2)
  summary(fit.c3)

# Model (iv)/Column 4: Initial Wage gap - Controls Chain/Ownership
  
  fit.c4 <- lm((y_fte.after-y_fte.before) ~ 
               d_ini.wage.gap + x_bk + x_kfc + x_roys + x_co.owned, 
             data = df2)
  summary(fit.c4)  
  
# Model (iv)/Column 4: Initial Wage gap - Controls Chain/Ownership + Regions 
  
  fit.c5 <- lm((y_fte.after-y_fte.before) ~ 
               d_ini.wage.gap + x_bk + x_kfc + x_roys + x_co.owned + x_south.j + x_central.j + x_northeast.pa + x_easton.pa, 
             data = df2)
  summary(fit.c5)  
  
  
```

```{r Table 5 - Specification tests of reduced form employment models, echo=FALSE}

# Khizer


```









































