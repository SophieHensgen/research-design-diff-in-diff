---
title: "RD-Group-Project-DiD"
author: "Sophie Hensgen"
date: "11/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readr)
library(tidyverse)
library(stargazer)
library(plotly)
library(kableExtra)
library(naniar)
```

## Load Data Set


```{r load data set}
df <- read.table("public.dat")
df

```

## Code


```{r arrange data, echo=FALSE}

# arrange data to better observe

arrange(df, V1)

```

```{r Rename Varibales, echo=FALSE}

## changing into tibble
df <- as_tibble(df)

## Rename Columns for a better workflow
# x stands for independent variable/covariates
# y stands for dependent variable
# d stands for treatement variable
df <- df %>% 
  rename(
    x_id = V1,
    x_store.name = V2, #chain 1=bk; 2=kfc; 3=roys; 4=wendys
    x_co.owned = V3,
    d_state = V4, #
    x_south.j = V5,
    x_central.j = V6,
    x_north.j = V7,
    x_northeast.pa = V8,
    x_easton.pa = V9,
    x_shore.j = V10, #
    x_callbacks.first = V11,
    y_full.emp = V12,
    y_part.emp = V13,
    y_managers = V14,
    x_st.wage.before = V15,
    x_months.raise = V16, 
    x_amount.raise = V17,
    x_cash.bounty = V18,
    y_employees.affected.n.minimum = V19,
    x_reduced = V20,
    x_open.hour = V21,
    x_open.per.day = V22,
    x_medium.soda = V23,
    x_small.fries = V24,
    x_entree = V25,
    x_cash.reg = V26,
    x_reg.11 = V27, 
    x_type.sec.interview = V28, # second wave
    x_status.sec.interview = V29,
    x_date.sec = V30,
    x_callbacks.sec = V31,
    y_full.emp.sec = V32,
    y_part.emp.sec = V33,
    y_managers.sec = V34,
    x_st.wage.after = V35,
    x_months.raise.sec = V36,
    x_amount.raise.sec = V37,
    x_special.program.sec = V38,
    x_reduced.price = V39,
    x_open.hour.sec = V40,
    x_open.per.day.sec = V41,
    x_medium.soda.sec = V42,
    x_small.fries.sec = V43,
    x_entree.sec = V44,
    x_cash.reg.sec = V45,
    x_reg.11.sec = V46
    )

```

```{r Creating Variables, echo=FALSE}

# Creating a new variable which says 1 if the restaurant was interviewed in the first wave
df$x_interviewed.w1 <- (df$x_interviewed.w1 = 1)

# creating new variables for each store (x_store.name) and state (d_state) into dummies. 

# x_bk dummy variable for burger king (1) or not (0)
df$x_bk <- gsub(2, 0, df$x_store.name) 
df$x_bk <- gsub(3, 0, df$x_bk) 
df$x_bk <- gsub(4, 0, df$x_bk) 

# x_kfc dummy variable for KFC (1) or not (0)
df$x_kfc <- gsub(1, 0, df$x_store.name) 
df$x_kfc <- gsub(3, 0, df$x_kfc) 
df$x_kfc <- gsub(4, 0, df$x_kfc) 
df$x_kfc <- gsub(2, 1, df$x_kfc) 

# x_roys dummy variable for Roys (1) or not (0)
df$x_roys <- gsub(1, 0, df$x_store.name) 
df$x_roys <- gsub(2, 0, df$x_roys) 
df$x_roys <- gsub(4, 0, df$x_roys) 
df$x_roys <- gsub(3, 1, df$x_roys) 

# x_wendys dummy variable for Wendys (1) or not (0)
df$x_wendys <- gsub(1, 0, df$x_store.name) 
df$x_wendys <- gsub(3, 0, df$x_wendys) 
df$x_wendys <- gsub(2, 0, df$x_wendys) 
df$x_wendys <- gsub(4, 1, df$x_wendys)

# d_nj dummy variable for restaurants in NJ (1) or not (0)
df$d_nj <- df$d_state

# d_nj dummy variable for restaurants in PA (1) or not (0)
df$d_pa <- gsub(0, 2, df$d_state)
df$d_pa <- gsub(1, 0, df$d_pa)
df$d_pa <- gsub(2, 1, df$d_pa)


```

```{r changing class , echo=FALSE}

# Some variables are a character vector, which cannot be used in a summary. Therefore they have to be changed. 

df[,12:14] <- lapply(df[,12:14], as.factor) #first convert into factor, and then into numeric. if tried to convert directly from character into numeric an error will appear.
df[,12:14] <- lapply(df[,12:14], as.numeric)

df[,15] <- lapply(df[,15], as.numeric)

df[,16:17] <- lapply(df[,16:17], as.factor) 
df[,16:17] <- lapply(df[,16:17], as.numeric)

df[,19] <- lapply(df[,19], as.factor)
df[,19] <- lapply(df[,19], as.numeric)

df[,23:27] <- lapply(df[,23:27], as.factor)
df[,23:27] <- lapply(df[,23:27], as.numeric)

df[,31:34] <- lapply(df[,31:34], as.factor)
df[,31:34] <- lapply(df[,31:34], as.numeric)

df[,35] <- lapply(df[,35], as.numeric)

df[,36:46] <- lapply(df[,36:46], as.factor)
df[,36:46] <- lapply(df[,36:46], as.numeric)

#convert into integer as it is a dummy variable with only 0 and 1, here convert directly to integer as the numbers would change if you first convert into factor
df[,48:51] <- lapply(df[,48:51], as.integer)

df[,53] <- lapply(df[,53], as.integer)


str(df)
```

```{r, echo=FALSE}
#Summary Statistic of a subset of the data frame df

#subsetting the data frame
df.select <- df %>%
  select(x_co.owned, x_south.j, x_central.j, x_north.j, x_northeast.pa, x_easton.pa, x_st.wage.before, x_st.wage.after, x_open.per.day, x_open.per.day.sec, y_full.emp, y_full.emp.sec, d_state, x_store.name)

#summary of the subset
stargazer(data.frame(df.select), type = "text", summary = TRUE)

```
```{r replace . with na, echo=FALSE}

  df <- df %>% replace_with_na(replace = list(y_full.emp = "." , x_st.wage.before = "." ,x_st.wage.after = ".", y_full.emp.sec = ".")) 

```


```{r Table 1 - Sample Size and response rate, echo=FALSE}

# first wave
# d_state

# count number interviewed
count.all.w1 <- df %>% 
  count(d_state)

count.all.w1

# response rate nj
count.all.per <- df %>%
  tally(x_interviewed.w1)%>%
  mutate(percent = n/473)

# response rate nj
count.nj.per <- df %>%
  count(d_state) %>%
  filter(d_state == 1) %>%
  mutate(percent = n/364)

# response rate pa
count.pa.per <- df %>%
  count(d_state) %>%
  filter(d_state == 0) %>%
  mutate(percent = n/109)

# second wave
# x_status.sec.interview, d_state

count.all.w2 <- df %>% 
  count(x_status.sec.interview)

count.nj <- df %>% 
  filter(d_state == 1) %>% # NJ
  count(x_status.sec.interview)

count.pa <- df %>% 
  filter(d_state == 0) %>% # PA
  count(x_status.sec.interview)

count.all.w2
count.nj
count.pa

```

```{r Table 2 - Means of Key Variables, echo=FALSE}

# Khizer 


```

```{r Figure 1 - Distribution of starting wage rates, echo=FALSE}

# Sophie 

### Replication of Figure 1

## creating specific objects for starter wage before respectively for nj and pa

x_st.wage.before.nj <- df$x_st.wage.before[df$d_nj == 1]
x_st.wage.before.pa <- df$x_st.wage.before[df$d_pa == 1]

# Plot for before treatment

# Set histogram bins
xbins <- list(start=4.20, end=5.60, size = 0.1)

# 
p.before <- plot_ly(alpha = 0.5) %>%
  add_histogram(x = x_st.wage.before.nj, 
                  xbins = xbins,
                  histnorm = "percent", 
                  name = "Wage Before (New Jersey)") %>%
  add_histogram(x = x_st.wage.before.pa, 
                  xbins = xbins,
                  histnorm = "percent",
                  name = "Wage Before (Pennsylvania)") %>%
  layout(barmode = "group", title = "February 1992",
           xaxis = list(tickvals=seq(4.25, 5.55, 0.1),
                        title = "Wage in $ per hour",
                        tickangle = 90),
           yaxis = list(range = c(0, 100)),
                      margin = list(b = 100, 
                          l = 80, 
                          r = 80, 
                          t = 80, 
                          pad = 0, 
                          autoexpand = TRUE))

p.before

## creating specific objects for starter wage before respectively for nj and pa

x_st.wage.after.nj <- df$x_st.wage.after[df$d_nj == 1]
x_st.wage.after.pa <- df$x_st.wage.after[df$d_pa == 1]

# Plot for wage after treatment

p.after <- plot_ly(alpha = 0.5) %>%
  add_histogram(x = x_st.wage.after.nj, 
                  xbins = xbins,
                  histnorm = "percent", 
                  name = "Wage After (New Jersey)") %>%
  add_histogram(x = x_st.wage.after.pa, 
                  xbins = xbins,
                  histnorm = "percent",
                  name = "Wage After (Pennsylvania)") %>%
  layout(barmode = "group", title = "February 1992",
           xaxis = list(tickvals=seq(4.25, 5.55, 0.1),
                        title = "Wage in $ per hour",
                        tickangle = 90),
           yaxis = list(range = c(0, 100)),
                      margin = list(b = 100, 
                          l = 80, 
                          r = 80, 
                          t = 80, 
                          pad = 0,
                          autoexpand = TRUE))

p.after
```

```{r Table 3 - Average Employment per store before and after the raise, echo=FALSE}

# Sophie

# Table 3: Column 1-3, Rows from left to right)

## 1st row: MEANs and SEs across subgroups
  
results.first <- df %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_full.emp) %>% # only keep variable of interest
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

# Add row with differences
  results.first <- bind_rows(results.first, results.first[2,]-results.first[1,])
  results.first$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(results.first, digits=2)

# Calculate SE for difference: SE = SQR(VAR/N + VAR/N)
  diff_se <- sqrt(results.first$var[1]/results.first$n[1] + results.first$var[2]/results.first$n[2])
  diff_se
  
## 2nd row: MEANs and SEs across subgroups
  
results.second <- df %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_full.emp.sec) %>% # only keep variable of interest - here dummy for state and employment for second time point (after treatment)
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

   
# Add row with differences
  results.second <- bind_rows(results.second, results.second[2,]-results.second[1,])
  results.second$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(results.second, digits=2)
  
## 3rd row: Change in MEANs and SEs between both time points

  results.compare <- bind_rows(results.first, results.second)
  results.compare <- select(results.compare, -8)
  results.compare <- bind_rows(results.compare, results.compare[4,]-results.compare[1,])
  results.compare <- bind_rows(results.compare, results.compare[5,]-results.compare[2,])
  results.compare <- bind_rows(results.compare, results.compare[6,]-results.compare[3,])
  results.compare$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(results.compare, digits=2)  
  
## 4th row: Change in MEANs and SEs between both time points, balanced sample
  
# Filter observations in both waves
  df.balanced <- df %>% na.omit
    
# Filter complete cases across all columns
  df.balanced <- df %>% filter(complete.cases(.)) 
    

# Means time point 1
  
results.balanced.first <- df.balanced %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_full.emp) %>% # only keep variable of interest
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

# Add row with differences
  results.balanced.first <- bind_rows(results.balanced.first, results.balanced.first[2,]-results.balanced.first[1,])
  kable(results.balanced.first, digits=2)

# Means time point 2
results.balanced.second <- df.balanced %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_full.emp.sec) %>% # only keep variable of interest 
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

   
# Add row with differences
  results.balanced.second <- bind_rows(results.balanced.second, results.balanced.second[2,]-results.balanced.second[1,])
  results.balanced.second$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(results.balanced.second, digits=2)
  
# Mean Differences 
  
results.balanced.compare <- bind_rows(results.balanced.first, results.balanced.second)
  results.balanced.compare <- select(results.balanced.compare, -8)
  results.balanced.compare <- bind_rows(results.balanced.compare, results.balanced.compare[4,]-results.balanced.compare[1,])
  results.balanced.compare <- bind_rows(results.balanced.compare, results.balanced.compare[5,]-results.balanced.compare[2,])
  results.balanced.compare <- bind_rows(results.balanced.compare, results.balanced.compare[6,]-results.balanced.compare[3,])
  results.balanced.compare$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(results.balanced.compare, digits=2)  
  
  
## 5th row: Change in MEANs and SEs between both time points, permanently closed set to 0
  
# Create a new variable where permanently closed stores have a FTE of 0
df$y_full.emp.sec.closed <- df$y_full.emp.sec
df$y_full.emp.sec.closed[df$x_status.sec.interview == 3] <- 0
    
# Filter complete cases across all columns
df.closed <- df %>% filter(complete.cases(.)) 
    
results.closed.first <- df.closed %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_full.emp) %>% # only keep variable of interest
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

# Add row with differences
  results.closed.first <- bind_rows(results.closed.first, results.closed.first[2,]-results.closed.first[1,])
  kable(results.closed.first, digits=2)

results.closed.second <- df.closed %>% 
            group_by(d_nj) %>% # group_by the treatment variable
            dplyr::select(d_nj, y_full.emp.sec.closed) %>% # only keep variable of interest 
            group_by(N = n(), .add = TRUE) %>% # count number of rows
            summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
            mutate(n = N - na_sum) %>% 
            mutate(se = sqrt(var/n))

   
# Add row with differences
  results.closed.second <- bind_rows(results.closed.second, results.closed.second[2,]-results.closed.second[1,])
  kable(results.closed.second, digits=2)
  
results.closed.compare <- bind_rows(results.first, results.second)
  results.closed.compare <- select(results.closed.compare, -8)
  results.closed.compare <- bind_rows(results.closed.compare, results.closed.compare[4,]-results.closed.compare[1,])
  results.closed.compare <- bind_rows(results.closed.compare, results.closed.compare[5,]-results.closed.compare[2,])
  results.closed.compare <- bind_rows(results.closed.compare, results.closed.compare[6,]-results.closed.compare[3,])
  results.closed.compare$group<- c("Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference", "Control (Pennsylvania)", "Treatment (New Jersey)", "Difference")
  kable(results.closed.compare, digits=2)    

  
```

```{r Table 3 - Average Employment per store before and after the raise, column 4-6, echo=FALSE}

# Sophie 

### Table 3: Column 4-6, Row 1 (from left to right)

## First row: FTE before Treatment

# Column 4

results.r1.c4 <- df %>%
  group_by(d_nj) %>%
  dplyr::select(d_nj, x_st.wage.before, y_full.emp) %>%
  filter(d_nj == 1 & x_st.wage.before == 4.25) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - d_nj_na_sum) %>% 
  mutate(se = sqrt(d_nj_var/n))

# Column 5

results.r1.c5 <- df %>%
  group_by(d_nj) %>%
  dplyr::select(d_nj, x_st.wage.before, y_full.emp) %>%
  filter(x_st.wage.before > 4.25 & x_st.wage.before < 5 & d_nj == 1) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - d_nj_na_sum) %>% 
  mutate(se = sqrt(d_nj_var/n))

# Column 6

results.r1.c6 <- df %>%
  group_by(d_nj) %>%
  dplyr::select(d_nj, x_st.wage.before, y_full.emp) %>%
  filter(x_st.wage.before > 4.99 & d_nj == 1) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - d_nj_na_sum) %>% 
  mutate(se = sqrt(d_nj_var/n))

# Combining all the results for row 1

results.compare.r1 <- bind_rows(results.r1.c4, results.r1.c5, results.r1.c6)
kable(results.compare.r1, digits=2)


## Second row: After treatment

# Column 4

r2.c4 <- df %>%
  group_by(d_nj) %>%
  filter(d_nj == 1 & x_st.wage.before == 4.25) %>%
  dplyr::select(y_full.emp.sec) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean = mean, var = var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - d_nj_na_sum) %>% 
  mutate(se = sqrt(d_nj_var/n))

# Column 5

r2.c5 <- df %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.25 & x_st.wage.before < 5 & d_nj == 1) %>%
  dplyr::select(y_full.emp.sec) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - d_nj_na_sum) %>% 
  mutate(se = sqrt(d_nj_var/n))

# Column 6

r2.c6 <- df %>%
  group_by(d_nj) %>%
  filter(x_st.wage.before > 4.99 & d_nj == 1) %>%
  dplyr::select(y_full.emp) %>%
  group_by(N = n()) %>%
  summarize_all(funs(mean, var, na_sum = sum(is.na(.))), na.rm = TRUE) %>% # aggregate/summarize data
  mutate(n = N - d_nj_na_sum) %>% 
  mutate(se = sqrt(d_nj_var/n))

# Combining all the results for row 1

results.compare.r2 <- bind_rows(r2.c4, r2.c5) #, r2.c6)
kable(results.compare.r2, digits=2)

## Third row: After treatment

#results.compare.r3 <- rbind(results.compare.r2, results.compare.r1)
  #results.compare.r3 <- select(results.compare.r3, )
  results.compare.r3 <- bind_rows(results.compare.r3, results.compare.r3[4,]-results.compare.r3[1,])
  results.compare.r3 <- bind_rows(results.compare.r3, results.compare.r3[5,]-results.compare.r3[2,])
  results.compare.r3 <- bind_rows(results.compare.r3, results.compare.r3[6,]-results.compare.r3[3,])
  results.compare.r3$group<- c()
  kable(results.compare, digits=2)  
```

```{r Table 4 - Reduced Form Models for change in employment, echo=FALSE}

# Sophie 


```

```{r Table 5 - Specification tests of reduced form employment models, echo=FALSE}

# Khizer


```









































